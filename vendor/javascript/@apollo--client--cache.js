// @apollo/client/cache@4.0.4 downloaded from https://ga.jspm.io/npm:@apollo/client@4.0.4/cache/index.js

import{WeakCache as e}from"@wry/caches";import{wrap as t,dep as i,Slot as s}from"optimism";import{Observable as r}from"rxjs";import{cacheSizes as n,isReference as o,canonicalStringify as a,addTypenameToDocument as c,DocumentTransform as l,print as f}from"@apollo/client/utilities";export{canonicalStringify,isReference}from"@apollo/client/utilities";import{__DEV__ as h}from"@apollo/client/utilities/environment";import{getFragmentDefinition as u,equalByQuery as d,getFragmentQueryDocument as p,getApolloCacheMemoryInternals as m,compact as y,isNonNullObject as g,isArray as b,isField as S,shouldInclude as _,resultKeyNameFromField as v,DeepMerger as F,createFragmentMap as w,getFragmentDefinitions as k,makeReference as O,maybeDeepFreeze as R,isNonEmptyArray as E,argumentsObjectFromField as T,storeKeyNameFromField as x,getStoreKeyName as j,stringifyForDisplay as I,getDefaultValues as C,getQueryDefinition as M,getMainDefinition as D,getFragmentFromSelection as A,mergeDeepArray as P,getOperationDefinition as N,cloneDeep as B,getInMemoryCacheMemoryInternals as W}from"@apollo/client/utilities/internal";import{invariant as z,newInvariantError as L}from"@apollo/client/utilities/invariant";import{equal as V}from"@wry/equality";import{Trie as Q}from"@wry/trie";import{disableWarningsSlot as U}from"@apollo/client/masking";import{Kind as q,visit as $}from"graphql";class ApolloCache{assumeImmutableResults=false;lookupFragment(e){return null}batch(e){const t=typeof e.optimistic==="string"?e.optimistic:e.optimistic===false?null:void 0;let i;this.performTransaction((()=>i=e.update(this)),t);return i}recordOptimisticTransaction(e,t){this.performTransaction(e,t)}transformDocument(e){return e}transformForLink(e){return e}identify(e){}gc(){return[]}modify(e){return false}readQuery(e,t=!!e.optimistic){return this.read({...e,rootId:e.id||"ROOT_QUERY",optimistic:t})}
/**
    * Watches the cache store of the fragment according to the options specified
    * and returns an `Observable`. We can subscribe to this
    * `Observable` and receive updated results through an
    * observer when the cache store changes.
    * 
    * You must pass in a GraphQL document with a single fragment or a document
    * with multiple fragments that represent what you are reading. If you pass
    * in a document with multiple fragments then you must also specify a
    * `fragmentName`.
    * 
    * @since 3.10.0
    * @param options - An object of type `WatchFragmentOptions` that allows
    * the cache to identify the fragment and optionally specify whether to react
    * to optimistic updates.
    */watchFragment(e){const{fragment:t,fragmentName:i,from:s,optimistic:n=true,...o}=e;const a=this.getFragmentDoc(t,i);const c=typeof s==="undefined"||typeof s==="string"?s:this.identify(s);if(h){const e=i||u(t).name.value;c||h&&z.warn(109,e)}const l={...o,returnPartialData:true,id:c,query:a,optimistic:n};let f;return new r((t=>this.watch({...l,immediate:true,callback:i=>{let s=i.result;s===null&&(s={});if(f&&d(a,{data:f.result},{data:s},e.variables))return;const r={data:s,dataState:i.complete?"complete":"partial",complete:!!i.complete};i.missing&&(r.missing=i.missing.missing);f={...i,result:s};t.next(r)}})))}getFragmentDoc=t(p,{max:n["cache.fragmentQueryDocuments"]||1e3,cache:e});readFragment(e,t=!!e.optimistic){return this.read({...e,query:this.getFragmentDoc(e.fragment,e.fragmentName),rootId:e.id,optimistic:t})}writeQuery({id:e,data:t,...i}){return this.write(Object.assign(i,{dataId:e||"ROOT_QUERY",result:t}))}writeFragment({id:e,data:t,fragment:i,fragmentName:s,...r}){return this.write(Object.assign(r,{query:this.getFragmentDoc(i,s),dataId:e,result:t}))}updateQuery(e,t){return this.batch({update(i){const s=i.readQuery(e);const r=t(s);if(r===void 0||r===null)return s;i.writeQuery({...e,data:r});return r}})}updateFragment(e,t){return this.batch({update(i){const s=i.readFragment(e);const r=t(s);if(r===void 0||r===null)return s;i.writeFragment({...e,data:r});return r}})}}h&&(ApolloCache.prototype.getMemoryInternals=m);class MissingFieldError extends Error{message;path;query;variables;constructor(e,t,i,s){super(e);this.message=e;this.path=t;this.query=i;this.variables=s;this.name="MissingFieldError";if(Array.isArray(this.path)){this.missing=this.message;for(let e=this.path.length-1;e>=0;--e)this.missing={[this.path[e]]:this.missing}}else this.missing=this.path;this.__proto__=MissingFieldError.prototype}missing}const{hasOwnProperty:K}=Object.prototype;function Y({__typename:e,id:t,_id:i},s){if(typeof e==="string"){s&&(s.keyObject=t!=null?{id:t}:i!=null?{_id:i}:void 0);t==null&&i!=null&&(t=i);if(t!=null)return`${e}:${typeof t==="number"||typeof t==="string"?t:JSON.stringify(t)}`}}const J={dataIdFromObject:Y,resultCaching:true};function G(e){return y(J,e)}function H(e,t){return o(t)?e.get(t.__ref,"__typename"):t&&t.__typename}const X=/^[_a-z][_0-9a-z]*/i;function Z(e){const t=e.match(X);return t?t[0]:e}function ee(e,t,i){return!!g(t)&&(b(t)?t.every((t=>ee(e,t,i))):e.selections.every((e=>{if(S(e)&&_(e,i)){const s=v(e);return K.call(t,s)&&(!e.selectionSet||ee(e.selectionSet,t[s],i))}return true})))}function te(e){return g(e)&&!o(e)&&!b(e)}function ie(){return new F}function se(e,t){const i=w(k(e));return{fragmentMap:i,lookupFragment(e){let s=i[e];!s&&t&&(s=t.lookup(e));return s||null}}}const re={};const ne=()=>re;const oe={};class EntityStore{policies;group;data={};constructor(e,t){this.policies=e;this.group=t}toObject(){return{...this.data}}has(e){return this.lookup(e,true)!==void 0}get(e,t){this.group.depend(e,t);if(K.call(this.data,e)){const i=this.data[e];if(i&&K.call(i,t))return i[t]}return t==="__typename"&&K.call(this.policies.rootTypenamesById,e)?this.policies.rootTypenamesById[e]:this instanceof Layer?this.parent.get(e,t):void 0}lookup(e,t){t&&this.group.depend(e,"__exists");return K.call(this.data,e)?this.data[e]:this instanceof Layer?this.parent.lookup(e,t):this.policies.rootTypenamesById[e]?{}:void 0}merge(e,t){let i;o(e)&&(e=e.__ref);o(t)&&(t=t.__ref);const s=typeof e==="string"?this.lookup(i=e):e;const r=typeof t==="string"?this.lookup(i=t):t;if(!r)return;z(typeof i==="string",95);const n=new F(le).merge(s,r);this.data[i]=n;if(n!==s){delete this.refs[i];if(this.group.caching){const e={};s||(e.__exists=1);Object.keys(r).forEach((t=>{if(!s||s[t]!==n[t]){e[t]=1;const i=Z(t);i===t||this.policies.hasKeyArgs(n.__typename,i)||(e[i]=1);n[t]!==void 0||this instanceof Layer||delete n[t]}}));!e.__typename||s&&s.__typename||this.policies.rootTypenamesById[i]!==n.__typename||delete e.__typename;Object.keys(e).forEach((e=>this.group.dirty(i,e)))}}}modify(e,t,i){const s=this.lookup(e);if(s){const r={};let n=false;let a=true;const c={DELETE:re,INVALIDATE:oe,isReference:o,toReference:this.toReference,canRead:this.canRead,readField:(t,i)=>this.policies.readField(typeof t==="string"?{fieldName:t,from:i||O(e)}:t,{store:this})};Object.keys(s).forEach((l=>{const f=Z(l);let u=s[l];if(u===void 0)return;const d=typeof t==="function"?t:t[l]||(i?void 0:t[f]);if(d){let t=d===ne?re:d(R(u),{...c,fieldName:f,storeFieldName:l,storage:this.getStorage(e,l)});if(t===oe)this.group.dirty(e,l);else{t===re&&(t=void 0);if(t!==u){r[l]=t;n=true;u=t;if(h){const e=e=>{if(this.lookup(e.__ref)===void 0){h&&z.warn(96,e);return true}};if(o(t))e(t);else if(Array.isArray(t)){let i=false;let s;for(const r of t){if(o(r)){i=true;if(e(r))break}else if(typeof r==="object"&&!!r){const[e]=this.policies.identify(r);e&&(s=r)}if(i&&s!==void 0){h&&z.warn(97,s);break}}}}}}}u!==void 0&&(a=false)}));if(n){this.merge(e,r);if(a){this instanceof Layer?this.data[e]=void 0:delete this.data[e];this.group.dirty(e,"__exists")}return true}}return false}delete(e,t,i){const s=this.lookup(e);if(s){const r=this.getFieldValue(s,"__typename");const n=t&&i?this.policies.getStoreFieldName({typename:r,fieldName:t,args:i}):t;return this.modify(e,n?{[n]:ne}:ne,!!i)}return false}evict(e,t){let i=false;if(e.id){K.call(this.data,e.id)&&(i=this.delete(e.id,e.fieldName,e.args));this instanceof Layer&&this!==t&&(i=this.parent.evict(e,t)||i);(e.fieldName||i)&&this.group.dirty(e.id,e.fieldName||"__exists")}return i}clear(){this.replace(null)}extract(){const e=this.toObject();const t=[];this.getRootIdSet().forEach((e=>{K.call(this.policies.rootTypenamesById,e)||t.push(e)}));t.length&&(e.__META={extraRootIds:t.sort()});return e}replace(e){Object.keys(this.data).forEach((t=>{e&&K.call(e,t)||this.delete(t)}));if(e){const{__META:t,...i}=e;Object.keys(i).forEach((e=>{this.merge(e,i[e])}));t&&t.extraRootIds.forEach(this.retain,this)}}rootIds={};retain(e){return this.rootIds[e]=(this.rootIds[e]||0)+1}release(e){if(this.rootIds[e]>0){const t=--this.rootIds[e];t||delete this.rootIds[e];return t}return 0}getRootIdSet(e=new Set){Object.keys(this.rootIds).forEach(e.add,e);this instanceof Layer?this.parent.getRootIdSet(e):Object.keys(this.policies.rootTypenamesById).forEach(e.add,e);return e}gc(){const e=this.getRootIdSet();const t=this.toObject();e.forEach((i=>{if(K.call(t,i)){Object.keys(this.findChildRefIds(i)).forEach(e.add,e);delete t[i]}}));const i=Object.keys(t);if(i.length){let e=this;while(e instanceof Layer)e=e.parent;i.forEach((t=>e.delete(t)))}return i}refs={};findChildRefIds(e){if(!K.call(this.refs,e)){const t=this.refs[e]={};const i=this.data[e];if(!i)return t;const s=new Set([i]);s.forEach((e=>{o(e)&&(t[e.__ref]=true);g(e)&&Object.keys(e).forEach((t=>{const i=e[t];g(i)&&s.add(i)}))}))}return this.refs[e]}makeCacheKey(){return this.group.keyMaker.lookupArray(arguments)}getFieldValue=(e,t)=>R(o(e)?this.get(e.__ref,t):e&&e[t]);canRead=e=>o(e)?this.has(e.__ref):typeof e==="object";toReference=(e,t)=>{if(typeof e==="string")return O(e);if(o(e))return e;const[i]=this.policies.identify(e);if(i){const s=O(i);t&&this.merge(i,e);return s}};get supportsResultCaching(){return this.group.caching}}class CacheGroup{caching;parent;d=null;keyMaker;constructor(e,t=null){this.caching=e;this.parent=t;this.resetCaching()}resetCaching(){this.d=this.caching?i():null;this.keyMaker=new Q}depend(e,t){if(this.d){this.d(ae(e,t));const i=Z(t);i!==t&&this.d(ae(e,i));this.parent&&this.parent.depend(e,t)}}dirty(e,t){this.d&&this.d.dirty(ae(e,t),t==="__exists"?"forget":"setDirty")}}function ae(e,t){return t+"#"+e}function ce(e,t){fe(e)&&e.group.depend(t,"__exists")}class Root extends EntityStore{constructor({policies:e,resultCaching:t=true,seed:i}){super(e,new CacheGroup(t));i&&this.replace(i)}stump=new Stump(this);addLayer(e,t){return this.stump.addLayer(e,t)}removeLayer(){return this}storageTrie=new Q;getStorage(){return this.storageTrie.lookupArray(arguments)}}EntityStore.Root=Root;class Layer extends EntityStore{id;parent;replay;group;constructor(e,t,i,s){super(t.policies,s);this.id=e;this.parent=t;this.replay=i;this.group=s;i(this)}addLayer(e,t){return new Layer(e,this,t,this.group)}removeLayer(e){const t=this.parent.removeLayer(e);if(e===this.id){this.group.caching&&Object.keys(this.data).forEach((e=>{const i=this.data[e];const s=t.lookup(e);if(s)if(i)i!==s&&Object.keys(i).forEach((t=>{V(i[t],s[t])||this.group.dirty(e,t)}));else{this.group.dirty(e,"__exists");Object.keys(s).forEach((t=>{this.group.dirty(e,t)}))}else this.delete(e)}));return t}return t===this.parent?this:t.addLayer(this.id,this.replay)}toObject(){return{...this.parent.toObject(),...this.data}}findChildRefIds(e){const t=this.parent.findChildRefIds(e);return K.call(this.data,e)?{...t,...super.findChildRefIds(e)}:t}getStorage(...e){let t=this.parent;while(t.parent)t=t.parent;return t.getStorage(...e)}}class Stump extends Layer{constructor(e){super("EntityStore.Stump",e,(()=>{}),new CacheGroup(e.group.caching,e.group))}removeLayer(){return this}merge(e,t){return this.parent.merge(e,t)}}function le(e,t,i){const s=e[i];const r=t[i];return V(s,r)?s:r}function fe(e){return!!(e&&e.supportsResultCaching)}const he={};function ue(e){const t=JSON.stringify(e);return he[t]||(he[t]={})}function de(e){const t=ue(e);return t.keyFieldsFn||(t.keyFieldsFn=(t,i)=>{const s=(e,t)=>i.readField(t,e);const r=i.keyObject=me(e,(e=>{let r=be(i.storeObject,e,s);r===void 0&&t!==i.storeObject&&K.call(t,e[0])&&(r=be(t,e,ge));z(r!==void 0,98,e.join("."),t);return r}));return`${i.typename}:${JSON.stringify(r)}`})}function pe(e){const t=ue(e);return t.keyArgsFn||(t.keyArgsFn=(t,{field:i,variables:s,fieldName:r})=>{const n=me(e,(e=>{const r=e[0];const n=r.charAt(0);if(n!=="@")if(n!=="$"){if(t)return be(t,e)}else{const t=r.slice(1);if(s&&K.call(s,t)){const i=e.slice(0);i[0]=t;return be(s,i)}}else if(i&&E(i.directives)){const t=r.slice(1);const n=i.directives.find((e=>e.name.value===t));const o=n&&T(n,s);return o&&be(o,e.slice(1))}}));const o=JSON.stringify(n);(t||o!=="{}")&&(r+=":"+o);return r})}function me(e,t){const i=new F;return ye(e).reduce(((e,s)=>{let r=t(s);if(r!==void 0){for(let e=s.length-1;e>=0;--e)r={[s[e]]:r};e=i.merge(e,r)}return e}),{})}function ye(e){const t=ue(e);if(!t.paths){const i=t.paths=[];const s=[];e.forEach(((t,r)=>{if(b(t)){ye(t).forEach((e=>i.push(s.concat(e))));s.length=0}else{s.push(t);if(!b(e[r+1])){i.push(s.slice(0));s.length=0}}}))}return t.paths}function ge(e,t){return e[t]}function be(e,t,i){i=i||ge;return Se(t.reduce((function e(t,s){return b(t)?t.map((t=>e(t,s))):t&&i(t,s)}),e))}function Se(e){return g(e)?b(e)?e.map(Se):me(Object.keys(e).sort(),(t=>be(e,t))):e}const _e=new s;const ve=new WeakMap;function Fe(e){let t=ve.get(e);t||ve.set(e,t={vars:new Set,dep:i()});return t}function we(e){Fe(e).vars.forEach((t=>t.forgetCache(e)))}function ke(e){Fe(e).vars.forEach((t=>t.attachCache(e)))}function Oe(e){const t=new Set;const i=new Set;const s=function(n){if(arguments.length>0){if(e!==n){e=n;t.forEach((e=>{Fe(e).dep.dirty(s);Re(e)}));const r=Array.from(i);i.clear();r.forEach((t=>t(e)))}}else{const e=_e.getValue();if(e){r(e);Fe(e).dep(s)}}return e};s.onNextChange=e=>{i.add(e);return()=>{i.delete(e)}};const r=s.attachCache=e=>{t.add(e);Fe(e).vars.add(s);return s};s.forgetCache=e=>t.delete(e);return s}function Re(e){e.broadcastWatches&&e.broadcastWatches()}function Ee(e){return e.args!==void 0?e.args:e.field?T(e.field,e.variables):null}const Te=()=>{};const xe=(e,t)=>t.fieldName;const je=(e,t,{mergeObjects:i})=>i(e,t);const Ie=(e,t)=>t;class Policies{config;typePolicies={};toBeAdded={};supertypeMap=new Map;fuzzySubtypes=new Map;cache;rootIdsByTypename={};rootTypenamesById={};usingPossibleTypes=false;constructor(e){this.config=e;this.config={dataIdFromObject:Y,...e};this.cache=this.config.cache;this.setRootTypename("Query");this.setRootTypename("Mutation");this.setRootTypename("Subscription");e.possibleTypes&&this.addPossibleTypes(e.possibleTypes);e.typePolicies&&this.addTypePolicies(e.typePolicies)}identify(e,t){const i=this;const s=t&&(t.typename||t.storeObject?.__typename)||e.__typename;if(s===this.rootTypenamesById.ROOT_QUERY)return["ROOT_QUERY"];const r=t&&t.storeObject||e;const n={...t,typename:s,storeObject:r,readField:t&&t.readField||((...e)=>{const t=Me(e,r);return i.readField(t,{store:i.cache.data,variables:t.variables})})};let o;const a=s&&this.getTypePolicy(s);let c=a&&a.keyFn||this.config.dataIdFromObject;U.withValue(true,(()=>{while(c){const t=c({...e,...r},n);if(!b(t)){o=t;break}c=de(t)}}));o=o?String(o):void 0;return n.keyObject?[o,n.keyObject]:[o]}addTypePolicies(e){Object.keys(e).forEach((t=>{const{queryType:i,mutationType:s,subscriptionType:r,...n}=e[t];i&&this.setRootTypename("Query",t);s&&this.setRootTypename("Mutation",t);r&&this.setRootTypename("Subscription",t);K.call(this.toBeAdded,t)?this.toBeAdded[t].push(n):this.toBeAdded[t]=[n]}))}updateTypePolicy(e,t,i){const s=this.getTypePolicy(e);const{keyFields:r,fields:n}=t;function o(e,t){e.merge=typeof t==="function"?t:t===true?je:t===false?Ie:e.merge}o(s,t.merge);s.keyFn=r===false?Te:b(r)?de(r):typeof r==="function"?r:s.keyFn;n&&Object.keys(n).forEach((t=>{let s=i[t];s&&s?.typename===e||(s=i[t]={typename:e});const r=n[t];if(typeof r==="function")s.read=r;else{const{keyArgs:e,read:t,merge:i}=r;s.keyFn=e===false?xe:b(e)?pe(e):typeof e==="function"?e:s.keyFn;typeof t==="function"&&(s.read=t);o(s,i)}s.read&&s.merge&&(s.keyFn=s.keyFn||xe)}))}setRootTypename(e,t=e){const i="ROOT_"+e.toUpperCase();const s=this.rootTypenamesById[i];if(t!==s){z(!s||s===e,99,e);s&&delete this.rootIdsByTypename[s];this.rootIdsByTypename[t]=i;this.rootTypenamesById[i]=t}}addPossibleTypes(e){this.usingPossibleTypes=true;Object.keys(e).forEach((t=>{this.getSupertypeSet(t,true);e[t].forEach((e=>{this.getSupertypeSet(e,true).add(t);const i=e.match(X);i&&i[0]===e||this.fuzzySubtypes.set(e,new RegExp(e))}))}))}getTypePolicy(e){if(!K.call(this.typePolicies,e)){const t=this.typePolicies[e]={};t.fields={};let i=this.supertypeMap.get(e);if(!i&&this.fuzzySubtypes.size){i=this.getSupertypeSet(e,true);this.fuzzySubtypes.forEach(((t,s)=>{if(t.test(e)){const e=this.supertypeMap.get(s);e&&e.forEach((e=>i.add(e)))}}))}i&&i.size&&i.forEach((e=>{const{fields:i,...s}=this.getTypePolicy(e);Object.assign(t,s);Object.assign(t.fields,i)}))}const t=this.toBeAdded[e];t&&t.length&&t.splice(0).forEach((t=>{this.updateTypePolicy(e,t,this.typePolicies[e].fields)}));return this.typePolicies[e]}getFieldPolicy(e,t){if(e)return this.getTypePolicy(e).fields[t]}getSupertypeSet(e,t){let i=this.supertypeMap.get(e);!i&&t&&this.supertypeMap.set(e,i=new Set);return i}fragmentMatches(e,t,i,s){if(!e.typeCondition)return true;if(!t)return false;const r=e.typeCondition.name.value;if(t===r)return true;if(this.usingPossibleTypes&&this.supertypeMap.has(r)){const n=this.getSupertypeSet(t,true);const o=[n];const a=e=>{const t=this.getSupertypeSet(e,false);t&&t.size&&o.indexOf(t)<0&&o.push(t)};let c=!!(i&&this.fuzzySubtypes.size);let l=false;for(let f=0;f<o.length;++f){const u=o[f];if(u.has(r)){if(!n.has(r)){l&&h&&z.warn(100,t,r);n.add(r)}return true}u.forEach(a);if(c&&f===o.length-1&&ee(e.selectionSet,i,s)){c=false;l=true;this.fuzzySubtypes.forEach(((e,i)=>{const s=t.match(e);s&&s[0]===t&&a(i)}))}}}return false}hasKeyArgs(e,t){const i=this.getFieldPolicy(e,t);return!!(i&&i.keyFn)}getStoreFieldName(e){const{typename:t,fieldName:i}=e;const s=this.getFieldPolicy(t,i);let r;let n=s&&s.keyFn;if(n&&t){const s={typename:t,fieldName:i,field:e.field||null,variables:e.variables};const o=Ee(e);while(n){const e=n(o,s);if(!b(e)){r=e||i;break}n=pe(e)}}r===void 0&&(r=e.field?x(e.field,e.variables):j(i,Ee(e)));return r===false?i:i===Z(r)?r:i+":"+r}readField(e,t){const i=e.from;if(!i)return;const s=e.field||e.fieldName;if(!s)return;if(e.typename===void 0){const s=t.store.getFieldValue(i,"__typename");s&&(e.typename=s)}const r=this.getStoreFieldName(e);const n=Z(r);const a=t.store.getFieldValue(i,r);const c=this.getFieldPolicy(e.typename,n);const l=c&&c.read;if(l){const s=Ce(this,i,e,t,t.store.getStorage(o(i)?i.__ref:i,r));return _e.withValue(this.cache,l,[a,s])}return a}getReadFunction(e,t){const i=this.getFieldPolicy(e,t);return i&&i.read}getMergeFunction(e,t,i){let s=this.getFieldPolicy(e,t);let r=s&&s.merge;if(!r&&i){s=this.getTypePolicy(i);r=s&&s.merge}return r}runMergeFunction(e,t,{field:i,typename:s,merge:r},n,o){if(r===je)return De(n.store)(e,t);if(r===Ie)return t;n.overwrite&&(e=void 0);return r(e,t,Ce(this,void 0,{typename:s,fieldName:i.name.value,field:i,variables:n.variables},n,o||{}))}}function Ce(e,t,i,s,r){const n=e.getStoreFieldName(i);const a=Z(n);const c=i.variables||s.variables;const{toReference:l,canRead:f}=s.store;return{args:Ee(i),field:i.field||null,fieldName:a,storeFieldName:n,variables:c,isReference:o,toReference:l,storage:r,cache:e.cache,canRead:f,readField(...i){return e.readField(Me(i,t,c),s)},mergeObjects:De(s.store)}}function Me(e,t,i){const{0:s,1:r,length:n}=e;let o;if(typeof s==="string")o={fieldName:s,from:n>1?r:t};else{o={...s};K.call(o,"from")||(o.from=t)}h&&o.from===void 0&&h&&z.warn(101,I(Array.from(e)));void 0===o.variables&&(o.variables=i);return o}function De(e){return function(t,i){if(b(t)||b(i))throw L(102);if(g(t)&&g(i)){const s=e.getFieldValue(t,"__typename");const r=e.getFieldValue(i,"__typename");const n=s&&r&&s!==r;if(n)return i;if(o(t)&&te(i)){e.merge(t.__ref,i);return t}if(te(t)&&o(i)){e.merge(t,i.__ref);return i}if(te(t)&&te(i))return{...t,...i}}return i}}function Ae(e){return[e.selectionSet,e.objectOrReference,e.context]}class StoreReader{executeSelectionSet;executeSubSelectedArray;config;knownResults=new WeakMap;constructor(e){this.config=e;this.executeSelectionSet=t((e=>{const t=Ae(e);const i=this.executeSelectionSet.peek(...t);if(i)return i;ce(e.context.store,e.enclosingRef.__ref);return this.execSelectionSetImpl(e)}),{max:n["inMemoryCache.executeSelectionSet"]||5e4,keyArgs:Ae,makeCacheKey(e,t,i){if(fe(i.store))return i.store.makeCacheKey(e,o(t)?t.__ref:t,i.varString)}});this.executeSubSelectedArray=t((e=>{ce(e.context.store,e.enclosingRef.__ref);return this.execSubSelectedArrayImpl(e)}),{max:n["inMemoryCache.executeSubSelectedArray"]||1e4,makeCacheKey({field:e,array:t,context:i}){if(fe(i.store))return i.store.makeCacheKey(e,t,i.varString)}})}diffQueryAgainstStore({store:e,query:t,rootId:i="ROOT_QUERY",variables:s,returnPartialData:r=true}){const n=this.config.cache.policies;s={...C(M(t)),...s};const o=O(i);const c=this.executeSelectionSet({selectionSet:D(t).selectionSet,objectOrReference:o,enclosingRef:o,context:{store:e,query:t,policies:n,variables:s,varString:a(s),...se(t,this.config.fragments)}});let l;c.missing&&(l=new MissingFieldError(Pe(c.missing),c.missing,t,s));const f=!l;const{result:h}=c;return{result:f||r?Object.keys(h).length===0?null:h:null,complete:f,missing:l}}isFresh(e,t,i,s){if(fe(s.store)&&this.knownResults.get(e)===i){const r=this.executeSelectionSet.peek(i,t,s);if(r&&e===r.result)return true}return false}execSelectionSetImpl({selectionSet:e,objectOrReference:t,enclosingRef:i,context:s}){if(o(t)&&!s.policies.rootTypenamesById[t.__ref]&&!s.store.has(t.__ref))return{result:{},missing:`Dangling reference to missing ${t.__ref} object`};const{variables:r,policies:n,store:a}=s;const l=a.getFieldValue(t,"__typename");const f=[];let h;const u=new F;typeof l!=="string"||n.rootIdsByTypename[l]||f.push({__typename:l});function d(e,t){e.missing&&(h=u.merge(h,{[t]:e.missing}));return e.result}const p=new Set(e.selections);p.forEach((e=>{if(_(e,r))if(S(e)){let r=n.readField({fieldName:e.name.value,field:e,variables:s.variables,from:t},s);const a=v(e);r===void 0?c.added(e)||(h=u.merge(h,{[a]:`Can't find field '${e.name.value}' on ${o(t)?t.__ref+" object":"object "+JSON.stringify(t,null,2)}`})):b(r)?r.length>0&&(r=d(this.executeSubSelectedArray({field:e,array:r,enclosingRef:i,context:s}),a)):e.selectionSet&&r!=null&&(r=d(this.executeSelectionSet({selectionSet:e.selectionSet,objectOrReference:r,enclosingRef:o(r)?r:i,context:s}),a));r!==void 0&&f.push({[a]:r})}else{const t=A(e,s.lookupFragment);if(!t&&e.kind===q.FRAGMENT_SPREAD)throw L(103,e.name.value);t&&n.fragmentMatches(t,l)&&t.selectionSet.selections.forEach(p.add,p)}}));const m=P(f);const y={result:m,missing:h};const g=R(y);g.result&&this.knownResults.set(g.result,e);return g}execSubSelectedArrayImpl({field:e,array:t,enclosingRef:i,context:s}){let r;let n=new F;function a(e,t){e.missing&&(r=n.merge(r,{[t]:e.missing}));return e.result}e.selectionSet&&(t=t.filter(s.store.canRead));t=t.map(((t,r)=>{if(t===null)return null;if(b(t))return a(this.executeSubSelectedArray({field:e,array:t,enclosingRef:i,context:s}),r);if(e.selectionSet)return a(this.executeSelectionSet({selectionSet:e.selectionSet,objectOrReference:t,enclosingRef:o(t)?t:i,context:s}),r);h&&Ne(s.store,e,t);return t}));return{result:t,missing:r}}}function Pe(e){try{JSON.stringify(e,((e,t)=>{if(typeof t==="string")throw t;return t}))}catch(e){return e}}function Ne(e,t,i){if(!t.selectionSet){const s=new Set([i]);s.forEach((i=>{if(g(i)){z(!o(i),104,H(e,i),t.name.value);Object.values(i).forEach(s.add,s)}}))}}function Be(e,t,i){const s=`${t}${i}`;let r=e.flavors.get(s);r||e.flavors.set(s,r=e.clientOnly===t&&e.deferred===i?e:{...e,clientOnly:t,deferred:i});return r}class StoreWriter{cache;reader;fragments;constructor(e,t,i){this.cache=e;this.reader=t;this.fragments=i}writeToStore(e,{query:t,result:i,dataId:s,variables:r,overwrite:n}){const c=N(t);const l=ie();r={...C(c),...r};const f={store:e,written:{},merge(e,t){return l.merge(e,t)},variables:r,varString:a(r),...se(t,this.fragments),overwrite:!!n,incomingById:new Map,clientOnly:false,deferred:false,flavors:new Map};const u=this.processSelectionSet({result:i||{},dataId:s,selectionSet:c.selectionSet,mergeTree:{map:new Map},context:f});if(!o(u))throw L(105,i);f.incomingById.forEach((({storeObject:t,mergeTree:i,fieldNodeSet:s},r)=>{const n=O(r);if(i&&i.map.size){const e=this.applyMerges(i,n,t,f);if(o(e))return;t=e}if(h&&!f.overwrite){const e={};s.forEach((t=>{t.selectionSet&&(e[t.name.value]=true)}));const r=t=>e[Z(t)]===true;const o=e=>{const t=i&&i.map.get(e);return Boolean(t&&t.info&&t.info.merge)};Object.keys(t).forEach((e=>{r(e)&&!o(e)&&qe(n,t,e,f.store)}))}e.merge(r,t)}));e.retain(u.__ref);return u}processSelectionSet({dataId:e,result:t,selectionSet:i,context:s,mergeTree:r}){const{policies:n}=this.cache;let a={};const l=e&&n.rootTypenamesById[e]||$e(t,i,s.fragmentMap)||e&&s.store.get(e,"__typename");"string"===typeof l&&(a.__typename=l);const f=(...e)=>{const t=Me(e,a,s.variables);if(o(t.from)){const e=s.incomingById.get(t.from.__ref);if(e){const i=n.readField({...t,from:e.storeObject},s);if(i!==void 0)return i}}return n.readField(t,s)};const u=new Set;this.flattenFields(i,t,s,l).forEach(((e,i)=>{const s=v(i);const d=t[s];u.add(i);if(d!==void 0){const t=n.getStoreFieldName({typename:l,fieldName:i.name.value,field:i,variables:e.variables});const s=ze(r,t);let c=this.processFieldValue(d,i,i.selectionSet?Be(e,false,false):e,s);let h;i.selectionSet&&(o(c)||te(c))&&(h=f("__typename",c));const u=n.getMergeFunction(l,i.name.value,h);u?s.info={field:i,typename:l,merge:u}:Qe(r,t);a=e.merge(a,{[t]:c})}else!h||e.clientOnly||e.deferred||c.added(i)||n.getReadFunction(l,i.name.value)||z.error(106,v(i),t)}));try{const[r,o]=n.identify(t,{typename:l,selectionSet:i,fragmentMap:s.fragmentMap,storeObject:a,readField:f});e=e||r;o&&(a=s.merge(a,o))}catch(t){if(!e)throw t}if("string"===typeof e){const n=O(e);const o=s.written[e]||(s.written[e]=[]);if(o.indexOf(i)>=0)return n;o.push(i);if(this.reader&&this.reader.isFresh(t,n,i,s))return n;const c=s.incomingById.get(e);if(c){c.storeObject=s.merge(c.storeObject,a);c.mergeTree=Le(c.mergeTree,r);u.forEach((e=>c.fieldNodeSet.add(e)))}else s.incomingById.set(e,{storeObject:a,mergeTree:Ve(r)?void 0:r,fieldNodeSet:u});return n}return a}processFieldValue(e,t,i,s){return t.selectionSet&&e!==null?b(e)?e.map(((e,r)=>{const n=this.processFieldValue(e,t,i,ze(s,r));Qe(s,r);return n})):this.processSelectionSet({result:e,selectionSet:t.selectionSet,context:i,mergeTree:s}):h?B(e):e}flattenFields(e,t,i,s=$e(t,e,i.fragmentMap)){const r=new Map;const{policies:n}=this.cache;const o=new Q(false);(function e(a,c){const l=o.lookup(a,c.clientOnly,c.deferred);if(!l.visited){l.visited=true;a.selections.forEach((o=>{if(!_(o,i.variables))return;let{clientOnly:a,deferred:l}=c;a&&l||!E(o.directives)||o.directives.forEach((e=>{const t=e.name.value;t==="client"&&(a=true);if(t==="defer"){const t=T(e,i.variables);t&&t.if===false||(l=true)}}));if(S(o)){const e=r.get(o);if(e){a=a&&e.clientOnly;l=l&&e.deferred}r.set(o,Be(i,a,l))}else{const r=A(o,i.lookupFragment);if(!r&&o.kind===q.FRAGMENT_SPREAD)throw L(107,o.name.value);r&&n.fragmentMatches(r,s,t,i.variables)&&e(r.selectionSet,Be(i,a,l))}}))}})(e,i);return r}applyMerges(e,t,i,s,r){if(e.map.size&&!o(i)){const n=b(i)||!o(t)&&!te(t)?void 0:t;const a=i;n&&!r&&(r=[o(n)?n.__ref:n]);let c;const l=(e,t)=>b(e)?typeof t==="number"?e[t]:void 0:s.store.getFieldValue(e,String(t));e.map.forEach(((e,t)=>{const i=l(n,t);const o=l(a,t);if(void 0===o)return;r&&r.push(t);const f=this.applyMerges(e,i,o,s,r);if(f!==o){c=c||new Map;c.set(t,f)}r&&z(r.pop()===t)}));if(c){i=b(a)?a.slice(0):{...a};c.forEach(((e,t)=>{i[t]=e}))}}return e.info?this.cache.policies.runMergeFunction(t,i,e.info,s,r&&s.store.getStorage(...r)):i}}const We=[];function ze({map:e},t){e.has(t)||e.set(t,We.pop()||{map:new Map});return e.get(t)}function Le(e,t){if(e===t||!t||Ve(t))return e;if(!e||Ve(e))return t;const i=e.info&&t.info?{...e.info,...t.info}:e.info||t.info;const s=e.map.size&&t.map.size;const r=s?new Map:e.map.size?e.map:t.map;const n={info:i,map:r};if(s){const i=new Set(t.map.keys());e.map.forEach(((e,s)=>{n.map.set(s,Le(e,t.map.get(s)));i.delete(s)}));i.forEach((i=>{n.map.set(i,Le(t.map.get(i),e.map.get(i)))}))}return n}function Ve(e){return!e||!(e.info||e.map.size)}function Qe({map:e},t){const i=e.get(t);if(i&&Ve(i)){We.push(i);e.delete(t)}}const Ue=new Set;function qe(e,t,i,s){const r=e=>{const t=s.getFieldValue(e,i);return typeof t==="object"&&t};const n=r(e);if(!n)return;const a=r(t);if(!a)return;if(o(n))return;if(V(n,a))return;if(Object.keys(n).every((e=>s.getFieldValue(a,e)!==void 0)))return;const c=s.getFieldValue(e,"__typename")||s.getFieldValue(t,"__typename");const l=Z(i);const f=`${c}.${l}`;if(Ue.has(f))return;Ue.add(f);const u=[];b(n)||b(a)||[n,a].forEach((e=>{const t=s.getFieldValue(e,"__typename");typeof t!=="string"||u.includes(t)||u.push(t)}));h&&z.warn(108,l,c,u.length?"either ensure all objects of type "+u.join(" and ")+" have an ID or a custom merge function, or ":"",f,{...n},{...a})}function $e(e,t,i){let s;for(const i of t.selections)if(S(i)){if(i.name.value==="__typename")return e[v(i)]}else s?s.push(i):s=[i];if(typeof e.__typename==="string")return e.__typename;if(s)for(const t of s){const s=$e(e,A(t,i).selectionSet,i);if(typeof s==="string")return s}}class InMemoryCache extends ApolloCache{data;optimisticData;config;watches=new Set;storeReader;storeWriter;addTypenameTransform=new l(c);maybeBroadcastWatch;assumeImmutableResults=true;policies;makeVar=Oe;constructor(e={}){super();this.config=G(e);this.policies=new Policies({cache:this,dataIdFromObject:this.config.dataIdFromObject,possibleTypes:this.config.possibleTypes,typePolicies:this.config.typePolicies});this.init()}init(){const e=this.data=new EntityStore.Root({policies:this.policies,resultCaching:this.config.resultCaching});this.optimisticData=e.stump;this.resetResultCache()}resetResultCache(){const{fragments:e}=this.config;this.addTypenameTransform.resetCache();e?.resetCaches();this.storeWriter=new StoreWriter(this,this.storeReader=new StoreReader({cache:this,fragments:e}),e);this.maybeBroadcastWatch=t(((e,t)=>this.broadcastWatch(e,t)),{max:n["inMemoryCache.maybeBroadcastWatch"]||5e3,makeCacheKey:e=>{const t=e.optimistic?this.optimisticData:this.data;if(fe(t)){const{optimistic:i,id:s,variables:r}=e;return t.makeCacheKey(e.query,e.callback,a({optimistic:i,id:s,variables:r}))}}});new Set([this.data.group,this.optimisticData.group]).forEach((e=>e.resetCaching()))}restore(e){this.init();e&&this.data.replace(e);return this}extract(e=false){return(e?this.optimisticData:this.data).extract()}read(e){const{returnPartialData:t=false}=e;return this.storeReader.diffQueryAgainstStore({...e,store:e.optimistic?this.optimisticData:this.data,config:this.config,returnPartialData:t}).result}write(e){try{++this.txCount;return this.storeWriter.writeToStore(this.data,e)}finally{--this.txCount||e.broadcast===false||this.broadcastWatches()}}modify(e){if(K.call(e,"id")&&!e.id)return false;const t=e.optimistic?this.optimisticData:this.data;try{++this.txCount;return t.modify(e.id||"ROOT_QUERY",e.fields,false)}finally{--this.txCount||e.broadcast===false||this.broadcastWatches()}}diff(e){return this.storeReader.diffQueryAgainstStore({...e,store:e.optimistic?this.optimisticData:this.data,rootId:e.id||"ROOT_QUERY",config:this.config})}watch(e){this.watches.size||ke(this);this.watches.add(e);e.immediate&&this.maybeBroadcastWatch(e);return()=>{this.watches.delete(e)&&!this.watches.size&&we(this);this.maybeBroadcastWatch.forget(e)}}gc(e){a.reset();f.reset();const t=this.optimisticData.gc();e&&!this.txCount&&e.resetResultCache&&this.resetResultCache();return t}retain(e,t){return(t?this.optimisticData:this.data).retain(e)}release(e,t){return(t?this.optimisticData:this.data).release(e)}identify(e){if(o(e))return e.__ref;try{return this.policies.identify(e)[0]}catch(e){h&&z.warn(e)}}evict(e){if(!e.id){if(K.call(e,"id"))return false;e={...e,id:"ROOT_QUERY"}}try{++this.txCount;return this.optimisticData.evict(e,this.data)}finally{--this.txCount||e.broadcast===false||this.broadcastWatches()}}reset(e){this.init();a.reset();if(e&&e.discardWatches){this.watches.forEach((e=>this.maybeBroadcastWatch.forget(e)));this.watches.clear();we(this)}else this.broadcastWatches();return Promise.resolve()}removeOptimistic(e){const t=this.optimisticData.removeLayer(e);if(t!==this.optimisticData){this.optimisticData=t;this.broadcastWatches()}}txCount=0;batch(e){const{update:t,optimistic:i=true,removeOptimistic:s,onWatchUpdated:r}=e;let n;const o=e=>{const{data:i,optimisticData:s}=this;++this.txCount;e&&(this.data=this.optimisticData=e);try{return n=t(this)}finally{--this.txCount;this.data=i;this.optimisticData=s}};const a=new Set;r&&!this.txCount&&this.broadcastWatches({...e,onWatchUpdated(e){a.add(e);return false}});typeof i==="string"?this.optimisticData=this.optimisticData.addLayer(i,o):i===false?o(this.data):o();typeof s==="string"&&(this.optimisticData=this.optimisticData.removeLayer(s));if(r&&a.size){this.broadcastWatches({...e,onWatchUpdated(e,t){const i=r.call(this,e,t);i!==false&&a.delete(e);return i}});a.size&&a.forEach((e=>this.maybeBroadcastWatch.dirty(e)))}else this.broadcastWatches(e);return n}performTransaction(e,t){return this.batch({update:e,optimistic:t||t!==null})}transformDocument(e){return this.addTypenameTransform.transformDocument(this.addFragmentsToDocument(e))}fragmentMatches(e,t){return this.policies.fragmentMatches(e,t)}lookupFragment(e){return this.config.fragments?.lookup(e)||null}broadcastWatches(e){this.txCount||this.watches.forEach((t=>this.maybeBroadcastWatch(t,e)))}addFragmentsToDocument(e){const{fragments:t}=this.config;return t?t.transform(e):e}broadcastWatch(e,t){const{lastDiff:i}=e;const s=this.diff(e);if(t){e.optimistic&&typeof t.optimistic==="string"&&(s.fromOptimisticTransaction=true);if(t.onWatchUpdated&&t.onWatchUpdated.call(this,e,s,i)===false)return}i&&V(i.result,s.result)||e.callback(e.lastDiff=s,i)}}h&&(InMemoryCache.prototype.getMemoryInternals=W);function Ke(...e){return new FragmentRegistry(...e)}class FragmentRegistry{registry={};constructor(...e){this.resetCaches();e.length&&this.register(...e)}register(...e){const t=new Map;e.forEach((e=>{k(e).forEach((e=>{t.set(e.name.value,e)}))}));t.forEach(((e,t)=>{if(e!==this.registry[t]){this.registry[t]=e;this.invalidate(t)}}));return this}invalidate(e){}resetCaches(){const i=FragmentRegistry.prototype;this.invalidate=(this.lookup=t(i.lookup.bind(this),{makeCacheKey:e=>e,max:n["fragmentRegistry.lookup"]||1e3})).dirty;this.transform=t(i.transform.bind(this),{cache:e,max:n["fragmentRegistry.transform"]||2e3});this.findFragmentSpreads=t(i.findFragmentSpreads.bind(this),{cache:e,max:n["fragmentRegistry.findFragmentSpreads"]||4e3})}lookup(e){return this.registry[e]||null}transform(e){const t=new Map;k(e).forEach((e=>{t.set(e.name.value,e)}));const i=new Set;const s=e=>{t.has(e)||i.add(e)};const r=e=>Object.keys(this.findFragmentSpreads(e)).forEach(s);r(e);const n=[];const o={};i.forEach((e=>{const i=t.get(e);if(i)r(o[e]=i);else{n.push(e);const t=this.lookup(e);t&&r(o[e]=t)}}));if(n.length){const t=[];n.forEach((e=>{const i=o[e];i&&t.push(i)}));t.length&&(e={...e,definitions:e.definitions.concat(t)})}return e}findFragmentSpreads(e){const t={};$(e,{FragmentSpread(e){t[e.name.value]=e}});return t}}export{ApolloCache,EntityStore,InMemoryCache,MissingFieldError,Policies,_e as cacheSlot,Ke as createFragmentRegistry,Y as defaultDataIdFromObject,Z as fieldNameFromStoreName,Oe as makeVar};

